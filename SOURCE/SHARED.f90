!======================================================================!
MODULE SHARED
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Declare parameters and variables to be shared across routines in
! HYBRID9.
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
IMPLICIT NONE
!----------------------------------------------------------------------!
SAVE
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Daily sums for diagnostics.
!----------------------------------------------------------------------!
REAL :: evap_day ! Evaporation                                  (mm/day)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Annual sums for diagnostics.
!----------------------------------------------------------------------!
REAL :: rnf_sum         ! Sum of runoff fluxes over 1-yr          (mm/s)
REAL :: evap_sum        ! Sum of evaporation fluxes over 1-yr     (mm/s)
!----------------------------------------------------------------------!
! Precipitation flux                                              (mm/s)
!----------------------------------------------------------------------!
REAL :: prec
REAL :: npp                 ! NPP                        (g[DM]/m^2/day)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Climate variables.
!----------------------------------------------------------------------!
! huss:   Specific humidity at time of maximum temperature     (kgw/kga)
! pr:     Precipitation flux                                  (kg/m^2/s)
! ps:     Surface air pressure                                      (Pa)
! rhs:    Relative humidity                                          (-)
! rlds:   Surface downwelling longwave radiation flux in air     (W/m^2)
! rsds:   Surface downwelling shortwave radiation flux in air    (W/m^2)
! tasmax: Maximum surface air temperature                            (K)
! tasmin: Minimum surface air temperature                            (K)
! tas:    Surface air temperature                                    (K)
! wind:   Wind speed at 10 metres                                  (m/s)
!----------------------------------------------------------------------!
! Surface Air Temperature                                            (K)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: tas (:,:,:)
!----------------------------------------------------------------------!
! Specific humidity at time of maximum temperature               (kg/kg)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: huss (:,:,:)
!----------------------------------------------------------------------!
! Surface air pressure                                              (Pa)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: ps (:,:,:)
!----------------------------------------------------------------------!
! Precipitation flux                                          (kg/m^2/s)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: pr (:,:,:)
!----------------------------------------------------------------------!
! Relative humidity                                                  (-)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: rhs (:,:,:)
!----------------------------------------------------------------------!
! Underground drainage from each soil layer and aquifer           (mm/s)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: rnff
!----------------------------------------------------------------------!
! Matric potentials of soil layers                                  (mm)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: smp
!----------------------------------------------------------------------!
! Equilibrium soil matric potentials of soil layers                 (mm)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: zq
!----------------------------------------------------------------------!
! Soil water inflow at top of layer                               (mm/s)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: qin
!----------------------------------------------------------------------!
! Soil water outflow at bottom of layer                           (mm/s)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: qout
!----------------------------------------------------------------------!
! Soil layer interface depths with reference to surface             (mm)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: zi
!----------------------------------------------------------------------!
! Soil layer thicknesses                                            (mm)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dz
!----------------------------------------------------------------------!
! Hydraulic conductivities at soil layer interfaces               (mm/s)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: hk
!----------------------------------------------------------------------!
! d(smp)/d(vol_liq)                                     (mm/(mm^3/mm^3))
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dsmpdw
!----------------------------------------------------------------------!
! d(qout)/d(vol_liq(I))                              (mm/s1)/(mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dqodw1
!----------------------------------------------------------------------!
! d(qout)/d(vol_liq(I+1))                             (mm/s)/(mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dqodw2
!----------------------------------------------------------------------!
! d(hk)/d(vol_liq)                                    (mm/s)/(mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dhkdw
!----------------------------------------------------------------------!
! d(qin)/d(vol_liq(I-1))                            ((mm/s)/(mm^3/mm^3))
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dqidw0
!----------------------------------------------------------------------!
! d(qin)/d(vol_liq(I))                              ((mm/s)/(mm^3/mm^3))
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dqidw1
!----------------------------------------------------------------------!
! "a" left of diagonal term of tridiagonal matrix.
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: amx
!----------------------------------------------------------------------!
! "b" diagonal column for tridiagonal matrix.
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: bmx
!----------------------------------------------------------------------!
! "c" right of diagonal of tridiagonal matrix.
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: cmx
!----------------------------------------------------------------------!
! "r" forcing term of tridiagonal matrix.
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: rmx
!----------------------------------------------------------------------!
! Change in soil water                                         (m^3/m^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: dwat,dwat2
!----------------------------------------------------------------------!
! For tridiagonal solution                                           (-)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: GAM
!----------------------------------------------------------------------!
! Volumetric soil water content                              (mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: theta
!----------------------------------------------------------------------!
! Equilibrium volumetric soil water content                  (mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: vol_eq
!----------------------------------------------------------------------!
! Porosity of soil                                           (mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: eff_porosity
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Sum of daily volumetric water in each soil layer over 1-yr (mm^3/mm^3)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: theta_sum (:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Plant mass                                                     (g[DM])
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: plant_mass (:,:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Plant length                                                      (mm)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: plant_length (:,:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Plant labile carbon, nitrogen, and phosphorus pools                (g)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: C_labile (:,:,:)
REAL, ALLOCATABLE :: N_labile (:,:,:)
REAL, ALLOCATABLE :: P_labile (:,:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Number of plants per grid-box                                      (-)
!----------------------------------------------------------------------!
INTEGER, ALLOCATABLE :: nplants (:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Maximum number of plants per grid_box                              (-)
!----------------------------------------------------------------------!
INTEGER, PARAMETER :: nplants_max = 1
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Maximum number of soil layers                                      (n)
!----------------------------------------------------------------------!
INTEGER, PARAMETER :: nsoil_layers_max = 8
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Number of ground layers (soil plus aquifer)                        (n)
!----------------------------------------------------------------------!
INTEGER, PARAMETER :: Nlevgrnd = 9
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
INTEGER :: my_id             ! Processor ID                          (n)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
REAL, PARAMETER :: zero = 0.0
REAL, PARAMETER :: one  = 1.0
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Physical constants
!----------------------------------------------------------------------!
REAL, PARAMETER :: pi = 3.14159                                ! (ratio)
!----------------------------------------------------------------------!
! Density of pure water                                         (kg/m^3)
!----------------------------------------------------------------------!
REAL, PARAMETER :: rhow = 1000.0
!----------------------------------------------------------------------!
! Molecular weight of dry air                                    (g/mol)
!----------------------------------------------------------------------!
REAL, PARAMETER :: mair = 28.9655
!----------------------------------------------------------------------!
! Molecular weight of water vapour                               (g/mol)
!----------------------------------------------------------------------!
REAL, PARAMETER :: mwat = 18.015
!----------------------------------------------------------------------!
! Gas constant                                                 (J/mol/K)
!----------------------------------------------------------------------!
REAL, PARAMETER :: gasc = 8.314510
!----------------------------------------------------------------------!
! Gas constant for air                                   (287.05 J/K/kg)
!----------------------------------------------------------------------!
REAL, PARAMETER :: rgas = 1000.0 * gasc / mair
!----------------------------------------------------------------------!
! Mass ratio of air to water vapour (0.62197)                    (ratio)
!----------------------------------------------------------------------!
REAL, PARAMETER :: mrat = mwat / mair
!----------------------------------------------------------------------!
! 1.0 / mrat (1.6078)                                            (ratio)
!----------------------------------------------------------------------!
REAL, PARAMETER :: bymrat = one / mrat
!----------------------------------------------------------------------!
! Coefficient of humidity in virtual temperature definition (0.6078) (?)
!----------------------------------------------------------------------!
REAL, PARAMETER :: deltx = bymrat - one
!----------------------------------------------------------------------!
! Latent heat of evaporation at 0 oC (2.5008E60                   (J/kg)
!----------------------------------------------------------------------!
REAL, PARAMETER :: lhe = 2.5008E6
!----------------------------------------------------------------------!
! Gas constant for water vapour (461.5)                         (J/K/kg)
!----------------------------------------------------------------------!
REAL, PARAMETER :: rvap = 1000.0 * gasc / mwat
!----------------------------------------------------------------------!
! Freezing point of water at 1 atm (273.16)                          (K)
!----------------------------------------------------------------------!
REAL, PARAMETER :: tf = 273.16
!----------------------------------------------------------------------!
! Minimum soil water potential                                      (mm)
!----------------------------------------------------------------------!
REAL, PARAMETER :: smpmin = -1.0E8
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Generic 2D input integer array.
!----------------------------------------------------------------------!
INTEGER, ALLOCATABLE :: data_in_2DI (:,:) 
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunks of soil properties of one soil layer read in at
! 30 arc-seconds.
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:), ALLOCATABLE :: theta_s_l1_in ! 0.001xcm^3/cm^3
REAL, DIMENSION (:,:), ALLOCATABLE :: k_s_l1_in     ! cm/day
REAL, DIMENSION (:,:), ALLOCATABLE :: lambda_l1_in  ! 0.001*unitless
REAL, DIMENSION (:,:), ALLOCATABLE :: psi_s_l1_in   ! cm
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunks of soil properties of one soil layer gridded to half-degree.
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:), ALLOCATABLE :: theta_s_l1 ! 0.001xcm^3/cm^3
REAL, DIMENSION (:,:), ALLOCATABLE :: k_s_l1     ! cm/day
REAL, DIMENSION (:,:), ALLOCATABLE :: lambda_l1  ! 0.001*unitless
REAL, DIMENSION (:,:), ALLOCATABLE :: psi_s_l1   ! cm
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk of saturated volumetric soil water                   (cm^3/cm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:,:), ALLOCATABLE :: theta_s
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk of saturated soil hydraulic conductivity                  (mm/s)
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:,:), ALLOCATABLE :: hksat
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk of pore size distribution index                              (-)
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:,:), ALLOCATABLE :: lambda
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk of Clapp and Hornberger "b"                                  (-)
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:,:), ALLOCATABLE :: bsw
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk of saturated capillary potential                            (mm)
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:,:), ALLOCATABLE :: psi_s
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk of minimum volumetric soil matric potential           (cm3/cm^3)
!----------------------------------------------------------------------!
REAL, DIMENSION (:,:,:), ALLOCATABLE :: theta_m
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk arrays of longitudes and latitudes.
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: lon (:)                  ! Longitude (degrees east)
REAL, ALLOCATABLE :: lat (:)                  ! Latitude (degrees north)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk arrays of processor IDs, soil textures, slopes, and Fmax.
!----------------------------------------------------------------------!
INTEGER, ALLOCATABLE :: block_sub  (:,:) ! Processor IDs             (-)
INTEGER, ALLOCATABLE :: soil_tex   (:,:) ! Soil texture from HWSD    (-)
![topo_slope not yet used]
REAL, ALLOCATABLE    :: topo_slope (:,:) ! Gridcell topo. slope    (deg)
REAL, ALLOCATABLE    :: Fmax       (:,:) ! Max. sat. fraction (fraction)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Ground layer node depths, positive downwards from surface = 0 mm  (mm)
!----------------------------------------------------------------------!
REAL, DIMENSION (:), ALLOCATABLE :: zc
REAL, DIMENSION (:), ALLOCATABLE :: zc_o ! Just soil layers for diag.
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk array of liquid soil water mass                         (kg/m^2)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: h2osoi_liq (:,:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk array of water table depth                                   (m)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: zwt (:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunk array of water in the unconfined aquifer                    (mm)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: wa (:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Chunck arrays of diagnostics.
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: axy_npp         (:,:,:) ! Mean NPP   (g[DM]/m^2/yr)
REAL, ALLOCATABLE :: axy_plant_mass  (:,:,:) ! Mean plant mass   (g[DM])
REAL, ALLOCATABLE :: axy_rnf         (:,:,:) ! Mean annual run-off(mm/s)
REAL, ALLOCATABLE :: axy_evap        (:,:,:) ! Mean annual evap.  (mm/s)
REAL, ALLOCATABLE :: axy_tas         (:,:,:) ! Mean annual tas       (K)
REAL, ALLOCATABLE :: axy_huss        (:,:,:) ! Mean annual huss  (kg/kg)
REAL, ALLOCATABLE :: axy_ps          (:,:,:) ! Mean annual ps       (Pa)
REAL, ALLOCATABLE :: axy_pr          (:,:,:) ! Mean annual pr (kg/m^2/s)
REAL, ALLOCATABLE :: axy_rhs         (:,:,:) ! Mean annual rhs    (%age)
!----------------------------------------------------------------------!
! Mean annual volumetric water content by soil layer            (m3/m^3)
REAL, ALLOCATABLE :: axy_theta       (:,:,:,:)
!----------------------------------------------------------------------!
REAL, ALLOCATABLE :: axy_theta_total (:,:,:)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Miscellaneous variables.
!----------------------------------------------------------------------!
REAL :: dt        ! Integration timestep                             (s)
REAL :: qflx_evap ! Local evaporation                             (mm/s)
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
! Truncation limit for numerical tests.
!----------------------------------------------------------------------!
REAL, PARAMETER :: trunc = 1.0E-8
!----------------------------------------------------------------------!

!----------------------------------------------------------------------!
END MODULE SHARED
!======================================================================!
